[workspace]
name = "G4.1-ArenaController"
version = "6.0.0"
description = "Arduino library for communicating with the Reiser Lab Modular LED panels display arena."
authors = ["Peter Polidoro <peter@polidoro.io>"]
channels = ["conda-forge"]

# Supported pixi platforms. Including these ensures pixi.lock can be solved
# for each OS/arch (Linux/macOS/Windows).
platforms = ["linux-64", "osx-64", "osx-arm64", "win-64"]

[dependencies]
# PlatformIO CLI (conda-forge, noarch). This provides the `pio` command.
platformio = ">=6.1.16,<7"
# Explicit Python for repo helper scripts (quantum_leaps_tools.py, version_sync.py)
python = ">=3.12,<3.13"
clang-tools = "*"
git = "*"

[tasks]
# List connected devices/ports (helps users discover COM3, /dev/ttyACM0, /dev/cu.usbmodem*, etc.)
ports = "pio device list"

# --------------------------------------------------------------------------------------
# clang-format
# --------------------------------------------------------------------------------------

[tasks.format]
description = "Format staged changes only (git clang-format) for C/C++/Arduino (.ino)."
cmd = "git clang-format --staged --style=file --binary clang-format --extensions c,cc,cpp,cxx,h,hh,hpp,hxx,ino"

[tasks.format-wip]
description = "Format working tree changes (allows unstaged files) for C/C++/Arduino (.ino)."
cmd = "git clang-format --style=file --binary clang-format --extensions c,cc,cpp,cxx,h,hh,hpp,hxx,ino --force"

[tasks.format-all]
description = "Reformat ALL tracked C/C++/Arduino files in the repo."
cmd = "python tools/clang_format_all.py"

[tasks.format-check]
description = "CI-friendly check: fails if files are not formatted (no writes)."
cmd = "python tools/clang_format_all.py --check"

# --------------------------------------------------------------------------------------
# PlatformIO build/upload tasks
#
# We select which example to build by setting PLATFORMIO_SRC_DIR (instead of editing
# platformio.ini).
#
# We also set PLATFORMIO_BUILD_DIR per example to avoid cross-example cache collisions.
# This dramatically reduces the need to run a clean when switching examples.
#
# Default example:
#   examples/ArenaControllerTeensy12-12
# --------------------------------------------------------------------------------------

[tasks.build]
args = [{ arg = "example", default = "examples/ArenaControllerTeensy12-12" }]
cmd = """
export PLATFORMIO_SRC_DIR="$PIXI_PROJECT_ROOT/{{ example }}" &&
export PLATFORMIO_BUILD_DIR="$PIXI_PROJECT_ROOT/.pio/build/{{ example }}/teensy41" &&
pio run -e teensy41
"""

[tasks.clean]
args = [{ arg = "example", default = "examples/ArenaControllerTeensy12-12" }]
cmd = """
export PLATFORMIO_SRC_DIR="$PIXI_PROJECT_ROOT/{{ example }}" &&
export PLATFORMIO_BUILD_DIR="$PIXI_PROJECT_ROOT/.pio/build/{{ example }}/teensy41" &&
pio run -e teensy41 -t clean
"""

[tasks.upload]
args = [
  { arg = "example", default = "examples/ArenaControllerTeensy12-12" },
  { arg = "port", default = "/dev/ttyACM0" },
]
cmd = """
export PLATFORMIO_SRC_DIR="$PIXI_PROJECT_ROOT/{{ example }}" &&
export PLATFORMIO_BUILD_DIR="$PIXI_PROJECT_ROOT/.pio/build/{{ example }}/teensy41" &&
pio run -e teensy41 -t upload --upload-port {{ port }}
"""

# Clean + Upload (upload implicitly builds)
[tasks.flash]
args = [
  { arg = "example", default = "examples/ArenaControllerTeensy12-12" },
  { arg = "port", default = "/dev/ttyACM0" },
]
cmd = """
export PLATFORMIO_SRC_DIR="$PIXI_PROJECT_ROOT/{{ example }}" &&
export PLATFORMIO_BUILD_DIR="$PIXI_PROJECT_ROOT/.pio/build/{{ example }}/teensy41" &&
pio run -e teensy41 -t clean &&
pio run -e teensy41 -t upload --upload-port {{ port }}
"""

# Clean + Build (compile only)
[tasks.rebuild]
args = [{ arg = "example", default = "examples/ArenaControllerTeensy12-12" }]
cmd = """
export PLATFORMIO_SRC_DIR="$PIXI_PROJECT_ROOT/{{ example }}" &&
export PLATFORMIO_BUILD_DIR="$PIXI_PROJECT_ROOT/.pio/build/{{ example }}/teensy41" &&
pio run -e teensy41 -t clean &&
pio run -e teensy41
"""

# --------------------------------------------------------------------------------------
# Version synchronization helpers
#
# Keep README.org, library.properties, and pixi.toml in sync (mostly version numbers).
# --------------------------------------------------------------------------------------

[tasks.check-version]
cmd = "python tools/version_sync.py check"

[tasks.set-version]
args = ["version"]
cmd = "python tools/version_sync.py set {{ version }}"

# --------------------------------------------------------------------------------------
# Quantum Leaps host tools pinned for qp-arduino compatibility:
#   QM     5.2.3
#   QTools 6.9.3 (QSPY)
#
# Tools are installed into: ./.tools/quantum-leaps/
# Suggestion: add ".tools/" to .gitignore to avoid committing downloads.
# --------------------------------------------------------------------------------------

# Install both QM and QTools
[tasks.ql-install]
cmd = "python tools/quantum_leaps_tools.py install"

# Launch QM (installs if missing)
[tasks.qm]
cmd = "python tools/quantum_leaps_tools.py qm"

# Install QM only
[tasks.qm-install]
cmd = "python tools/quantum_leaps_tools.py qm --install-only"

# Install QTools (and build qspy on Linux/macOS if needed)
[tasks.qtools-install]
cmd = "python tools/quantum_leaps_tools.py qtools-install"

# Run QSPY (any args after 'qspy' are forwarded to qspy, e.g. -c /dev/ttyACM0 -b 115200)
[tasks.qspy]
cmd = "python tools/quantum_leaps_tools.py qspy"

# Build tooling for qspy on POSIX
[target.linux-64.dependencies]
make = "*"
c-compiler = "*"

[target.osx-64.dependencies]
make = "*"
c-compiler = "*"

[target.osx-arm64.dependencies]
make = "*"
c-compiler = "*"
